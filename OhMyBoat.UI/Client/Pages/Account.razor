@page "/account"

@using Microsoft.AspNetCore.Components.Authorization;
@using Microsoft.AspNetCore.Authorization;
@using OhMyBoat.UI.Client.Extensions;
@using OhMyBoat.UI.Shared.Entidades;
@using OhMyBoat.UI.Shared;
@using System.Security.Claims
@using System;
@inject HttpClient HttpClient
@inject AuthenticationStateProvider authStateProvider;
@inject NavigationManager navManager
@inject IJSRuntime JsRuntime;
@inject NavigationManager Navegador;
@attribute [Authorize]

<Modal @ref="AccountModal" />

<div class="d-flex flex-column justify-content-center">   
    <div class="d-flex flex-column justify-content-center">
        <div class="d-flex flex-row align-items-center mb-5">
            <div class="image-div d-flex flex-row align-items-end">
                <img src=@Imagen class="profile-image" alt="User Profile">
                <p class="fs-1 mb-0"> Nombre: @Nombre</p>
            </div>
        </div>
        <div class="d-flex flex-column justify-content-center">
            <h2> Email : @Email </h2>
            <h2> Contacto : @Contacto</h2>
            <h2> Rol : @Rol.ToString()</h2>
        </div>
    </div>
    <div>       
        <button class="btn btn-primary" @onclick="EditAccount">
            <div class="d-flex flex-row align-items-center">
                <Icon Name="IconName.PencilFill" Size="IconSize.x4"></Icon>
                <span class="ms-2">Editar Perfil</span>
            </div>
        </button>        
        <button class="btn btn-primary" @onclick="ChangePassword">
            <div class="d-flex flex-row align-items-center">
                <Icon Name="IconName.LockFill" Size="IconSize.x4"></Icon>
                <span class="ms-2">Cambiar Contraseña</span>
            </div>
        </button>
    </div>
</div>

@code {
    private string Nombre = "";
    private string Email = "";
    private string Contacto = "";
    private string Rol = "";
    private string Imagen = "";
    private Usuario user = new Usuario() { Email = "", Nombre = "", Contacto = "" };

    private Modal AccountModal = default!;
    
    protected override async Task OnInitializedAsync()
    {
        await traerUsuario();
    }
    private async Task traerUsuario()
    {
        // TODO: Falta cursar CADP

        var coso = await authStateProvider.GetAuthenticationStateAsync();
        var emailDatos = coso.User.Claims.Where(c => c.Type == ClaimTypes.Email).First().Value;
        var log = new LoginDTO();
        log.Email = emailDatos;
        var nuevoU = await HttpClient.PostAsJsonAsync<LoginDTO>("api/usuario/ObtenerUsuario", log); // ver ese coso
        var mevoyamatar = await nuevoU.Content.ReadFromJsonAsync<Usuario>();

        if (mevoyamatar != null) { 

            Nombre = mevoyamatar.Nombre;
            Email = mevoyamatar.Email;
            Contacto = mevoyamatar.Contacto == null ? "-" : mevoyamatar.Contacto;
            Rol = Utils.CapitalizeString(mevoyamatar.Rol.ToString());
            StateHasChanged();
            Imagen = mevoyamatar.Base64imagen ?? "/user.png";

            // await JsRuntime.InvokeVoidAsync("alert", String(mevoyamatar.toString(),mevoyamatar.Nombre,me));

        } else await JsRuntime.InvokeVoidAsync("alert", "Explote");
    }
    private async Task ViewProfile() => navManager.NavigateTo("account");
    private async Task EditAccount() => navManager.NavigateTo("editProfile");
    private async Task ChangePassword() {
        var parameters = new Dictionary<string, object>();
        parameters.Add("OnClickCallback", EventCallback.Factory.Create<MouseEventArgs>(this, hideModal));
        await AccountModal.ShowAsync<ChangePassword>(title: "Cambiar Contraseña", parameters: parameters);
    }
    private async Task hideModal(){
        await AccountModal.HideAsync();
    }
    private async Task LogOut() {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Estás seguro de que quieres cerrar la sesión?"))
            return;
        var authState = (AuthenticationExtension) authStateProvider;
        await authState.ActualizarEstadoAutenticacion(null);
        navManager.NavigateTo("/", true);
    }
}
