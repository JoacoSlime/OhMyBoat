@inject HttpClient HttpClient
@using OhMyBoat.UI.Client.Extensions
@using OhMyBoat.UI.Shared
@using OhMyBoat.UI.Shared.Entidades
@inject IJSRuntime JsRuntime

@using Microsoft.AspNetCore.Components.Authorization;
@using Microsoft.AspNetCore.Authorization;
@inject NavigationManager Navegador

<div>
    @if (hasLoadedNavios) {
        <div class="alert alert-info" role="alert">
            <strong>Oh My Boat!</strong>, parece que no hay navios con deuda registrados.
        </div>
    } else {
        <PieChart @ref="pieChart" Width="500" Class="mb-5" />
    }
</div>

@code {
    private PieChart pieChart = default!;
    private PieChartOptions pieChartOptions = default!;
    private ChartData chartData = default!;
    private string[]? backgroundColors;
    private List<IChartDataset> chartDataSets = default!;
    private List<string> dataLabels = default!;
    private bool hasLoadedNavios = false;

    protected override async Task OnInitializedAsync()
    {
        var sucursales = await HttpClient.GetFromJsonAsync<List<Sucursal>>("api/turnos/ObtenerSucursales");
        dataLabels = sucursales?.ConvertAll(s => s.NombreSuck) ?? new();
        chartDataSets = await GetDataSets();
        chartData = new ChartData { Labels = dataLabels, Datasets = chartDataSets};

        pieChartOptions = new();
        pieChartOptions.Responsive = true;
        pieChartOptions.Plugins.Legend.Position = "right";
        await pieChart.InitializeAsync(chartData, pieChartOptions);
    }


    #region Data Preparation

    private async Task<List<IChartDataset>> GetDataSets()
    {
        var datasets = new List<IChartDataset>();
        var dataList = await HttpClient.GetFromJsonAsync<List<double>>("api/Reportes/GetReporteCantidadNaviosPorSucursal") ?? new();
        hasLoadedNavios = dataList.All(d => d==0d);
        datasets.Add(
            new PieChartDataset() {
                Label = "data",
                Data = dataList,
            }
        );
        return datasets;
    }

    #endregion  Data Preparation
}